name: Release and Deploy

on:
  push:
    tags:
      - 'v*'   # Correct trigger: matches v1.0.0, v2.3.4, etc.

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: middleeastsoftware/product-scanner-dashboard

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Image summary
        run: |
          echo "### Docker Image Built and Pushed :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  deploy-production:
    needs: build
    runs-on: ubuntu-latest
    environment: production
    if: ${{ vars.AUTO_DEPLOY_ENABLED == 'true' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update deployment manifest
        run: |
          VERSION="${{ needs.build.outputs.version }}"
          echo "Updating deployment to version $VERSION"

          sed -i "s|image: ghcr.io/middleeastsoftware/product-scanner-dashboard:.*|image: ghcr.io/middleeastsoftware/product-scanner-dashboard:$VERSION|g" deployments/k8s/deployment.yaml

          echo "Updated deployment.yaml:"
          grep "image: ghcr.io/middleeastsoftware/product-scanner-dashboard" deployments/k8s/deployment.yaml

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Configure kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Deploy to Kubernetes
        run: |
          echo "Applying deployment..."
          kubectl apply -f deployments/k8s/deployment.yaml
          kubectl apply -f deployments/k8s/service.yaml

          echo "Waiting for rollout to complete..."
          kubectl rollout status deployment/product-scanner-dashboard -n api --timeout=300s

      - name: Verify deployment
        run: |
          echo "### Kubernetes Deployment Successful :white_check_mark:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.build.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Namespace:** api" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pod Status:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n api -l app=product-scanner-dashboard >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Rollback on failure
        if: failure()
        run: |
          echo "### Deployment Failed - Rolling Back :warning:" >> $GITHUB_STEP_SUMMARY
          kubectl rollout undo deployment/product-scanner-dashboard -n api
          kubectl rollout status deployment/product-scanner-dashboard -n api --timeout=120s

  create-release:
    needs: build   # FIXED: no dependency on deploy-production
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          CURRENT_TAG="${GITHUB_REF#refs/tags/v}"
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)")
          else
            COMMITS=$(git log --pretty=format:"- %s (%h)" "$PREV_TAG"..HEAD)
          fi

          {
            echo 'changelog<<EOF'
            echo "$COMMITS"
            echo EOF
          } >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ needs.build.outputs.version }}
          body: |
            ## What's Changed

            ${{ steps.changelog.outputs.changelog }}

            ## Docker Image

            ```bash
            docker pull ghcr.io/middleeastsoftware/product-scanner-dashboard:${{ needs.build.outputs.version }}
            ```

            ## Kubernetes Deployment

            ```bash
            kubectl set image deployment/product-scanner-dashboard \
              product-scanner-dashboard=ghcr.io/middleeastsoftware/product-scanner-dashboard:${{ needs.build.outputs.version }} \
              -n api
            ```

            ## Access

            Dashboard: https://dashboard.middleeastsoftware.com

          draft: false
          prerelease: false
